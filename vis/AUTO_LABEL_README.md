# 自动格网标注工具使用说明

## 功能介绍

`auto_label.py` 是一个自动化格网标注脚本，可以：
- 自动分析格网的流量趋势（稳定/增长/衰减）
- 基于置信椭圆数据判断空间模式（静态/聚集/扩散）
- 自动提交标签并跳转到下一个格网
- 批量处理大量格网

## 工作原理

### 1. 流量趋势判断
- 计算2021和2024的日均流量总量
- 变化率 > +15% → **增长型**
- 变化率 < -15% → **衰减型**
- 其他 → **稳定型**

### 2. 空间模式判断
- 加载 `appdata/ellipses.json` 中的置信椭圆数据
- 计算2021和2024的椭圆面积（椭圆面积 = π × a × b）
- 面积变化 > +20% → **扩散型**
- 面积变化 < -20% → **聚集型**
- 其他 → **静态型**

### 3. 标签映射
| 流量趋势 | 空间模式 | 标签编号 | 标签名称 |
|---------|---------|---------|---------|
| 稳定 | 静态 | 1 | 稳定静态型 |
| 稳定 | 聚集 | 2 | 稳定聚集型 |
| 稳定 | 扩散 | 3 | 稳定扩散型 |
| 增长 | 静态 | 4 | 增长静态型 |
| 增长 | 聚集 | 5 | 增长聚集型 |
| 增长 | 扩散 | 6 | 增长扩散型 |
| 衰减 | 静态 | 7 | 衰减静态型 |
| 衰减 | 聚集 | 8 | 衰减聚集型 |
| 衰减 | 扩散 | 9 | 衰减扩散型 |

## 使用步骤

### 1. 启动服务器
```bash
cd vis
python server.py --port 8000
```

### 2. 打开浏览器
访问 http://127.0.0.1:8000

### 3. 设置标注参数
- 标注数量：例如 100
- 是否仅在当前筛选范围抽样
- 是否启用低流量过滤（可选）

### 4. 生成队列
点击"**开始打标签**"按钮，等待队列生成

### 5. 运行自动标注脚本
在终端中运行：
```bash
# 基本用法（标注100个）
python auto_label.py

# 自定义数量（标注50个）
python auto_label.py 50
```

### 6. 监督进度
- 终端会显示每个格网的判断结果
- 浏览器会自动跳转显示当前格网
- 右下角统计实时更新

## 输出示例

```
[已加载椭圆数据: /path/to/vis/appdata/ellipses.json]
=== 自动标注开始 ===
队列中有 100 个格网待标注
准备标注前 100 个

[1/100] 格网 ID: 109380
  → 判断: 8 (衰减聚集型)
  ✓ 已提交

[2/100] 格网 ID: 109381
  → 判断: 5 (增长聚集型)
  ✓ 已提交

...

=== 批次完成 ===
当前进度: 100/100
```

## 注意事项

1. **服务器必须运行**：确保 `server.py` 正在运行
2. **队列必须存在**：必须先在网页上点击"开始打标签"生成队列
3. **椭圆数据**：脚本会自动加载 `appdata/ellipses.json`，如果文件不存在会影响空间模式判断
4. **阈值调整**：如果发现判断不准确，可以在脚本中调整阈值：
   - 流量变化阈值：第125-127行（默认15%）
   - 椭圆面积变化阈值：第175-177行（默认20%）

## 高级功能

### 暂停和恢复
- 可以随时 Ctrl+C 停止脚本
- 队列状态会保存在服务器端
- 重新运行脚本会从当前位置继续

### 手动审核
- 脚本标注的截图会保存在 `vis/labels/shots/` 目录
- 可以手动查看截图进行审核
- 如果发现错误，可以手动重新标注或使用"撤销上一个"按钮

### 组合使用
建议工作流：
1. 先用脚本快速批量标注（如100个）
2. 然后手动抽查审核
3. 对错误标注进行修正

## 故障排查

### 问题：队列为空
**解决**：先在浏览器上点击"开始打标签"生成队列

### 问题：无法连接到服务器
**解决**：检查 `server.py` 是否在运行，端口是否为8055

### 问题：所有格网都判断为静态型
**解决**：检查 `appdata/ellipses.json` 是否存在且格式正确

## 技术支持

如有问题，请检查：
1. Python版本 >= 3.7
2. requests库已安装：`pip install requests`
3. 服务器正常运行：`http://127.0.0.1:8055/api/version`
